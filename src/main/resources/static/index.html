<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Kafka Order Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          color-scheme: light dark;
        }

        * {
          box-sizing: border-box;
        }

        body {
          margin: 0;
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          background: radial-gradient(circle at top, #1e293b, #020617);
          color: #e5e7eb;
        }

        .card {
          width: 100%;
          max-width: 520px;
          background: rgba(15, 23, 42, 0.95);
          border-radius: 18px;
          padding: 24px 22px 20px;
          box-shadow: 0 20px 45px rgba(0, 0, 0, 0.55);
          border: 1px solid rgba(148, 163, 184, 0.25);
          backdrop-filter: blur(12px);
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .title { font-size: 1.2rem; font-weight: 600; }
        .badge {
          font-size: 0.7rem;
          text-transform: uppercase;
          padding: 4px 8px;
          border-radius: 999px;
          border: 1px solid #22c55e33;
          color: #bbf7d0;
          background: #16a34a11;
        }

        .subtitle {
          font-size: 0.82rem;
          color: #9ca3af;
          margin-bottom: 16px;
        }

        form { display: grid; gap: 10px; margin-bottom: 14px; }
        label { font-size: 0.8rem; margin-bottom: 4px; color: #d1d5db; display: block; }

        .field { display: flex; flex-direction: column; }

        input {
          border-radius: 10px;
          border: 1px solid #4b5563;
          padding: 8px 10px;
          background: rgba(15, 23, 42, 0.9);
          color: #e5e7eb;
          font-size: 0.9rem;
        }
        input:focus { border-color: #22c55e; box-shadow: 0 0 0 1px #22c55e55; }

        .row { display: flex; gap: 10px; }

        .actions { display: flex; gap: 8px; }

        button {
          flex: 1;
          border-radius: 999px;
          padding: 8px 14px;
          font-size: 0.86rem;
          font-weight: 500;
          cursor: pointer;
        }

        .btn-primary {
          background: linear-gradient(135deg, #22c55e, #16a34a);
          color: #022c22;
        }

        .btn-secondary {
          background: #020617;
          border: 1px solid #4b5563;
          color: #e5e7eb;
        }

        .status {
          margin-top: 12px;
          padding: 10px;
          border-radius: 12px;
          font-size: 0.78rem;
          background: rgba(15, 23, 42, 0.9);
          border: 1px solid rgba(75, 85, 99, 0.9);
          min-height: 40px;
        }

        .orders-title {
          margin-top: 18px;
          font-size: 0.9rem;
          color: #9ca3af;
        }

        table {
          width: 100%;
          margin-top: 8px;
          border-collapse: collapse;
          font-size: 0.78rem;
        }

        th {
          border-bottom: 1px solid #334155;
          color: #cbd5f5;
          font-weight: 500;
          text-align: left;
          padding: 4px;
        }

        td {
          padding: 4px;
          border-bottom: 1px solid #111827;
        }

        tr:nth-child(even) td { background: rgba(15, 23, 42, 0.65); }
        tr:nth-child(odd) td { background: rgba(15, 23, 42, 0.4); }

        /* Fixed-size chart container */
        .chart-container {
          margin-top: 16px;
          padding: 10px;
          border-radius: 14px;
          border: 1px solid rgba(148, 163, 184, 0.3);
          background: rgba(15, 23, 42, 0.9);
        }
    </style>
</head>

<body>
<div class="card">

    <div class="header">
        <div class="title">Kafka Order Dashboard</div>
        <div class="badge">Avro Â· Kafka</div>
    </div>

    <div class="subtitle">
        Send test orders to <code>/api/orders</code> and track consumed order prices with a running average graph.
    </div>

    <!-- Form -->
    <form id="orderForm">
        <div class="field">
            <label>Order ID</label>
            <input id="orderId" type="text" required />
        </div>

        <div class="field">
            <label>Product</label>
            <input id="product" type="text" required />
        </div>

        <div class="field">
            <label>Price (LKR)</label>
            <input id="price" type="number" step="0.01" required />
        </div>

        <div class="actions">
            <button type="submit" class="btn-primary">ðŸš€ Send Order</button>
            <button type="button" id="avgBtn" class="btn-secondary">ðŸ“Š Get Average</button>
        </div>
    </form>

    <div class="status">
        <div>Status:</div>
        <div id="statusText">Waitingâ€¦</div>
    </div>

    <div class="orders-title">All Orders (Consumed)</div>

    <!-- Orders Table -->
    <table id="ordersTable">
        <thead>
        <tr><th>Order ID</th><th>Product</th><th>Price</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- FIXED SIZE CHART -->
    <div class="chart-container">
        <canvas id="ordersChart"
                width="480"
                height="200"
                style="max-width:480px; max-height:200px;">
        </canvas>
    </div>

    <div class="tagline">Backend: Spring Boot Â· Kafka Â· Avro</div>
</div>

<script>
    const statusText = document.getElementById("statusText");
    const ordersTableBody = document.querySelector("#ordersTable tbody");
    let chart = null;

    function setStatus(msg, error = false) {
        statusText.textContent = msg;
        statusText.style.color = error ? "#ffb3b3" : "#e5e7eb";
    }

    // ðŸ“Œ Draw fixed-size chart
    function drawChart(orders) {
        const ctx = document.getElementById("ordersChart").getContext("2d");

        if (chart) chart.destroy();

        if (!orders.length) return;

        const prices = orders.map(o => o.price);
        const labels = orders.map((_, i) => `#${i + 1}`);

        let running = [];
        let sum = 0;
        prices.forEach((p, i) => {
            sum += p;
            running.push(sum / (i + 1));
        });

        chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Price",
                        data: prices,
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: "Running Avg",
                        data: running,
                        borderWidth: 2,
                        tension: 0.3,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: false,     // FIXED SIZE
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: "#9ca3af" } },
                    y: { ticks: { color: "#9ca3af" } }
                }
            }
        });
    }

    async function loadOrders() {
        const res = await fetch("/api/orders/all");
        const orders = await res.json();

        ordersTableBody.innerHTML = "";

        if (!orders.length) {
            ordersTableBody.innerHTML =
                `<tr><td colspan="3" style="color:#9ca3af;">No orders yet.</td></tr>`;
            drawChart([]);
            return;
        }

        orders.forEach(o => {
            ordersTableBody.innerHTML += `
                <tr>
                  <td>${o.orderId}</td>
                  <td>${o.product}</td>
                  <td>${o.price}</td>
                </tr>`;
        });

        drawChart(orders);
    }

    document.getElementById("orderForm").addEventListener("submit", async e => {
        e.preventDefault();

        const body = {
            orderId: orderId.value,
            product: product.value,
            price: parseFloat(price.value)
        };

        setStatus("Sending orderâ€¦");

        const res = await fetch("/api/orders", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        setStatus(await res.text());
        await loadOrders();
    });

    document.getElementById("avgBtn")
        .addEventListener("click", async () => {
            const res = await fetch("/api/orders/average");
            const avg = await res.text();
            setStatus("Average: " + avg);
        });

    loadOrders();
</script>

</body>
</html>
